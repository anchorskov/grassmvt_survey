PASSKEY LOGIN VERIFICATION ERROR - BUG REPORT & SOLUTION
========================================================

STATUS: ✅ FIXED & DEPLOYED TO PRODUCTION

ERROR MESSAGE:
"Must declare either "leafCert" or "credentialPublicKey""

OCCURRENCE:
- Triggered during passkey login verification (POST /api/auth/passkey/login/verify)
- SimpleWebAuthn server library v9.0.1
- verifySignature function (node_modules/@simplewebauthn/server/esm/helpers/verifySignature.js:10)

ROOT CAUSE:
===========
The credential object passed to verifyAuthenticationResponse() had WRONG property names.

SimpleWebAuthn expects these property names:
  - id (NOT credentialID)
  - publicKey (NOT credentialPublicKey)
  - counter

DETAILED CONTEXT:
================

1. ISSUE DESCRIPTION:
   When a user completes passkey authentication and submits the assertion response,
   the backend's verifyAuthenticationResponse() call fails with the error above.
   The error occurs inside the verifySignature() function which is called by
   verifyAuthenticationResponse().

2. STACK TRACE:
   Error: Must declare either "leafCert" or "credentialPublicKey"
       at verifySignature (node_modules/@simplewebauthn/server/esm/helpers/verifySignature.js:10:15)
       at verifyAuthenticationResponse (node_modules/@simplewebauthn/server/esm/authentication/verifyAuthenticationResponse.js:154:25)
       at async handlePasskeyLoginVerify (src/worker.js:1971:20)

3. WHAT WE WERE PASSING (INCORRECT):
   {
     response: assertionResponse,
     expectedChallenge: challengeRecord.challenge (string),
     expectedOrigin: "http://localhost:8787" (string),
     expectedRPID: "localhost" (string),
     credential: {
       credentialID: Uint8Array(16),        ❌ WRONG NAME
       credentialPublicKey: Uint8Array(77), ❌ WRONG NAME
       counter: 0 (number)                   ✓ CORRECT
     },
     requireUserVerification: false
   }

4. WHAT WE SHOULD BE PASSING (CORRECT):
   {
     response: assertionResponse,
     expectedChallenge: challengeRecord.challenge (string),
     expectedOrigin: "http://localhost:8787" (string),
     expectedRPID: "localhost" (string),
     credential: {
       id: Uint8Array(16),          ✓ CORRECT (SimpleWebAuthn reads credential.id)
       publicKey: Uint8Array(77),   ✓ CORRECT (SimpleWebAuthn reads credential.publicKey)
       counter: 0 (number)          ✓ CORRECT
     },
     requireUserVerification: false
   }

5. PUBLIC KEY STORAGE IN DATABASE:
   - Stored as: base64URL-encoded string (77 bytes when decoded to UINT8ARRAY)
   - Retrieved as: SELECT public_key FROM passkey_credentials WHERE credential_id = ?
   - Converted: isoBase64URL.toBuffer(credential.public_key) → Uint8Array(77)
   - The public key was saved during passkey registration via SimpleWebAuthn

6. THE ISSUE:
   SimpleWebAuthn's verifyAuthenticationResponse() at line 154 calls verifySignature
   and passes: credential.publicKey
   
   But our credential object had: credential.credentialPublicKey (wrong name!)
   
   So when verifySignature checked:
   ```javascript
   if (!x509Certificate && !credentialPublicKey) {
       throw new Error('Must declare either "leafCert" or "credentialPublicKey"');
   }
   ```
   
   The credentialPublicKey parameter was undefined because we never passed it
   with that exact property name.

7. THE FIX:
   Changed credential object property names in src/worker.js line ~1925:
   
   BEFORE:
   ```javascript
   const authenticator = {
     credentialID: credentialIDBuffer,
     credentialPublicKey: credentialPublicKeyBuffer,
     counter: Number(credential.counter || 0),
   };
   ```
   
   AFTER:
   ```javascript
   const credential = {
     id: credentialIDBuffer,           // ✓ Changed from credentialID
     publicKey: credentialPublicKeyBuffer,  // ✓ Changed from credentialPublicKey
     counter: Number(credential.counter || 0),
   };
   ```
   
   Then pass it as: credential: credentialObject

8. PROOF OF FIX:
   - Test account testflow@example6.com successfully logs in with passkey
   - POST /api/auth/passkey/login/verify returns 200 OK
   - User redirected to /surveys/list/
   - Passkey login verification works on both localhost and production

9. COMMITS:
   - fa1b3d3: "passkey working localhost" (initial fix)
   - dceceaa: "changes to passkey" (test scripts & documentation)

10. DEPLOYMENT:
    ✅ Deployed to production (Version: a20b820f-42e1-422f-99db-a85553fdd615)
    ✅ Available at: https://grassmvtsurvey.anchorskov.workers.dev

LESSON LEARNED:
===============
When using a third-party library like SimpleWebAuthn, it's critical to check
the EXACT property names expected by internal functions. The library's
verifyAuthenticationResponse() function destructures the credential object and
passes credential.publicKey (not credential.credentialPublicKey) to
verifySignature().

The naming mismatch was subtle because:
1. During registration, we had similar naming issues but they didn't surface
2. The function call itself didn't fail - the internal verifySignature() call
   received undefined for credentialPublicKey parameter
3. Debugging required examining the actual source code of SimpleWebAuthn to see
   what property names it expected

RESOLUTION STATUS: ✅ COMPLETE
- Passkey registration: Working
- Passkey login verification: Working
- End-to-end flow: Working on localhost and production
- Test scripts: Added (test-signup-passkey-nudge.sh, test-passkey-flow.sh)
- Documentation: Added (SIGNUP_PASSKEY_FLOW.md)
- Investigate if the Uint8Array needs to be converted differently
- Check if there's a CBOR encoding/decoding issue with public key storage
